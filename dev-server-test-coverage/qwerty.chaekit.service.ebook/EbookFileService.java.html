<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>EbookFileService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">chaekit</a> &gt; <a href="index.source.html" class="el_package">qwerty.chaekit.service.ebook</a> &gt; <span class="el_source">EbookFileService.java</span></div><h1>EbookFileService.java</h1><pre class="source lang-java linenums">package qwerty.chaekit.service.ebook;

import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.web.multipart.MultipartFile;
import qwerty.chaekit.domain.ebook.Ebook;
import qwerty.chaekit.domain.ebook.EbookRepository;
import qwerty.chaekit.domain.member.publisher.PublisherProfileRepository;
import qwerty.chaekit.dto.ebook.upload.EbookDownloadResponse;
import qwerty.chaekit.dto.ebook.upload.EbookUploadRequest;
import qwerty.chaekit.global.enums.ErrorCode;
import qwerty.chaekit.global.exception.BadRequestException;
import qwerty.chaekit.global.exception.NotFoundException;
import qwerty.chaekit.global.properties.AwsProperties;
import qwerty.chaekit.service.member.admin.AdminService;
import software.amazon.awssdk.core.sync.RequestBody;
import software.amazon.awssdk.services.s3.S3Client;
import software.amazon.awssdk.services.s3.model.GetObjectRequest;
import software.amazon.awssdk.services.s3.model.PutObjectRequest;
import software.amazon.awssdk.services.s3.presigner.S3Presigner;
import software.amazon.awssdk.services.s3.presigner.model.PresignedGetObjectRequest;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.time.Duration;
import java.util.UUID;
import java.util.zip.ZipEntry;
import java.util.zip.ZipInputStream;

@Service
public class EbookFileService {
    private final EbookRepository ebookRepository;
    private final AdminService adminService;

    private final S3Client s3Client;
    private final S3Presigner s3Presigner;

    private final String bucketName;
    private final Long ebookMaxFileSize;
    private final Long presignedUrlExpirationTime;
    private final PublisherProfileRepository publisherRepository;

<span class="fc" id="L45">    public EbookFileService(EbookRepository ebookRepository, AdminService adminService, S3Client s3Client, S3Presigner s3Presigner, AwsProperties awsProperties, PublisherProfileRepository publisherRepository) {</span>
<span class="fc" id="L46">        this.ebookRepository = ebookRepository;</span>
<span class="fc" id="L47">        this.adminService = adminService;</span>

<span class="fc" id="L49">        this.s3Client = s3Client;</span>
<span class="fc" id="L50">        this.s3Presigner = s3Presigner;</span>

<span class="fc" id="L52">        this.bucketName = awsProperties.ebookBucketName();</span>
<span class="fc" id="L53">        this.ebookMaxFileSize = awsProperties.ebookMaxFileSize();</span>
<span class="fc" id="L54">        this.presignedUrlExpirationTime = awsProperties.presignedUrlExpirationTime();</span>
<span class="fc" id="L55">        this.publisherRepository = publisherRepository;</span>
<span class="fc" id="L56">    }</span>

    @Transactional
    public String uploadEbookByAdmin(EbookUploadRequest request) throws IOException {
<span class="nc" id="L60">        String title = request.title();</span>
<span class="nc" id="L61">        String author = request.author();</span>
<span class="nc" id="L62">        String description = request.description();</span>
<span class="nc" id="L63">        MultipartFile file = request.file();</span>

<span class="nc bnc" id="L65" title="All 4 branches missed.">        if (file == null || file.getOriginalFilename() == null) {</span>
<span class="nc" id="L66">            throw new BadRequestException(ErrorCode.EBOOK_FILE_MISSING);</span>
        }
<span class="nc" id="L68">        String fileName = file.getOriginalFilename();</span>
<span class="nc" id="L69">        String fileKey = UUID.randomUUID() + fileName.substring(fileName.lastIndexOf(&quot;.&quot;));</span>


<span class="nc bnc" id="L72" title="All 2 branches missed.">        if (file.getSize() &gt; ebookMaxFileSize) {</span>
<span class="nc" id="L73">            throw new BadRequestException(ErrorCode.EBOOK_FILE_SIZE_EXCEEDED);</span>
        }

<span class="nc bnc" id="L76" title="All 2 branches missed.">        if (!isValidEpub(file)) {</span>
<span class="nc" id="L77">            throw new BadRequestException(ErrorCode.INVALID_EBOOK_FILE);</span>
        }

        // 업로드
<span class="nc" id="L81">        try (InputStream inputStream = file.getInputStream()) {</span>
<span class="nc" id="L82">            s3Client.putObject(PutObjectRequest.builder()</span>
<span class="nc" id="L83">                            .bucket(bucketName)</span>
<span class="nc" id="L84">                            .key(fileKey)</span>
<span class="nc" id="L85">                            .build(),</span>
<span class="nc" id="L86">                    RequestBody.fromInputStream(inputStream, file.getSize()));</span>
        }

<span class="nc" id="L89">        Ebook ebook = Ebook.builder()</span>
<span class="nc" id="L90">                .title(title)</span>
<span class="nc" id="L91">                .author(author)</span>
<span class="nc" id="L92">                .description(description)</span>
<span class="nc" id="L93">                .size(file.getSize())</span>
<span class="nc" id="L94">                .fileKey(fileKey)</span>
<span class="nc" id="L95">                .publisher(publisherRepository.getReferenceById(adminService.getAdminPublisherId()))</span>
<span class="nc" id="L96">                .build();</span>
<span class="nc" id="L97">        ebookRepository.save(ebook);</span>

<span class="nc" id="L99">        return &quot;File uploaded successfully: &quot; + fileKey;</span>
    }

    private boolean isValidEpub(MultipartFile file) throws IOException {
        // epub 파일 검증 코드 by ChatGPT 4o mini
        // 파일 확장자 검사 (이미 .epub 파일로 확정)
<span class="nc" id="L105">        String fileName = file.getOriginalFilename();</span>
<span class="nc bnc" id="L106" title="All 4 branches missed.">        if (fileName == null || !fileName.toLowerCase().endsWith(&quot;.epub&quot;)) {</span>
<span class="nc" id="L107">            return false;</span>
        }

        // MIME 타입 검사
<span class="nc" id="L111">        String contentType = file.getContentType();</span>
<span class="nc bnc" id="L112" title="All 4 branches missed.">        if (contentType == null || !contentType.equals(&quot;application/epub+zip&quot;)) {</span>
<span class="nc" id="L113">            return false;</span>
        }

        // 실제 파일 내용 검사: EPUB 파일 내부에 mimetype 파일이 있는지 검사
<span class="nc" id="L117">        try (InputStream inputStream = file.getInputStream();</span>
<span class="nc" id="L118">             ZipInputStream zipInputStream = new ZipInputStream(inputStream)) {</span>

            ZipEntry entry;
<span class="nc bnc" id="L121" title="All 2 branches missed.">            while ((entry = zipInputStream.getNextEntry()) != null) {</span>
                // mimetype 파일이 있는지 확인
<span class="nc bnc" id="L123" title="All 2 branches missed.">                if (&quot;mimetype&quot;.equals(entry.getName())) {</span>
                    // &quot;mimetype&quot; 파일이 존재하고, 내용이 &quot;application/epub+zip&quot;인지 확인
<span class="nc" id="L125">                    BufferedReader reader = new BufferedReader(new InputStreamReader(zipInputStream));</span>
<span class="nc" id="L126">                    String mimetype = reader.readLine();</span>
<span class="nc bnc" id="L127" title="All 2 branches missed.">                    if (&quot;application/epub+zip&quot;.equals(mimetype)) {</span>
<span class="nc" id="L128">                        return true; // 유효한 EPUB 파일</span>
                    }
<span class="nc" id="L130">                }</span>
            }
<span class="nc bnc" id="L132" title="All 2 branches missed.">        }</span>

<span class="nc" id="L134">        return false; // &quot;mimetype&quot;이 없거나, 내용이 맞지 않으면 EPUB 파일이 아님</span>
    }

    @Transactional
    public EbookDownloadResponse getPresignedEbookUrl(Long ebookId) {
<span class="nc" id="L139">        Ebook ebook = ebookRepository.findById(ebookId)</span>
<span class="nc" id="L140">                .orElseThrow(() -&gt; new NotFoundException(ErrorCode.EBOOK_NOT_FOUND));</span>

<span class="nc" id="L142">        String fileKey = ebook.getFileKey();</span>

<span class="nc" id="L144">        return EbookDownloadResponse.of(generatePresignedUrlFromS3(fileKey));</span>
    }

    private String generatePresignedUrlFromS3(String fileName) {
<span class="nc" id="L148">        GetObjectRequest getObjectRequest = GetObjectRequest.builder()</span>
<span class="nc" id="L149">                .bucket(bucketName)</span>
<span class="nc" id="L150">                .key(fileName)</span>
<span class="nc" id="L151">                .build();</span>

<span class="nc" id="L153">        PresignedGetObjectRequest presignedRequest = s3Presigner.presignGetObject(builder -&gt; builder</span>
<span class="nc" id="L154">                .getObjectRequest(getObjectRequest)</span>
<span class="nc" id="L155">                .signatureDuration(Duration.ofSeconds(presignedUrlExpirationTime))</span>
        );

<span class="nc" id="L158">        return presignedRequest.url().toString();</span>
    }
}

</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.10.202304240956</span></div></body></html>