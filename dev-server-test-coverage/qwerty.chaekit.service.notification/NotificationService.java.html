<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>NotificationService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">chaekit</a> &gt; <a href="index.source.html" class="el_package">qwerty.chaekit.service.notification</a> &gt; <span class="el_source">NotificationService.java</span></div><h1>NotificationService.java</h1><pre class="source lang-java linenums">package qwerty.chaekit.service.notification;

import lombok.RequiredArgsConstructor;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.messaging.simp.SimpMessagingTemplate;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import qwerty.chaekit.domain.group.ReadingGroup;
import qwerty.chaekit.domain.group.activity.discussion.Discussion;
import qwerty.chaekit.domain.group.activity.discussion.comment.DiscussionComment;
import qwerty.chaekit.domain.highlight.Highlight;
import qwerty.chaekit.domain.highlight.comment.HighlightComment;
import qwerty.chaekit.domain.member.publisher.PublisherProfile;
import qwerty.chaekit.domain.member.user.UserProfile;
import qwerty.chaekit.domain.member.user.UserProfileRepository;
import qwerty.chaekit.domain.notification.entity.Notification;
import qwerty.chaekit.domain.notification.entity.NotificationType;
import qwerty.chaekit.domain.notification.repository.NotificationJpaRepository;
import qwerty.chaekit.dto.notification.NotificationResponse;
import qwerty.chaekit.dto.page.PageResponse;
import qwerty.chaekit.global.enums.ErrorCode;
import qwerty.chaekit.global.exception.ForbiddenException;
import qwerty.chaekit.global.exception.NotFoundException;
import qwerty.chaekit.global.security.resolver.UserToken;

@Service
@RequiredArgsConstructor
@Transactional(readOnly = true)
public class NotificationService {
    private final NotificationJpaRepository notificationJpaRepository;
    private final UserProfileRepository userProfileRepository;
    private final SimpMessagingTemplate simpMessagingTemplate;

    @Transactional
    public void createGroupJoinRequestNotification(UserProfile receiver, UserProfile sender, ReadingGroup group) {
<span class="fc" id="L37">        String message = String.format(&quot;%s님이 %s 그룹에 가입을 요청했습니다.&quot;, sender.getNickname(), group.getName());</span>
<span class="fc" id="L38">        Notification notification = new Notification(receiver, sender, null,group, null,null,null,NotificationType.GROUP_JOIN_REQUEST, message);</span>
<span class="fc" id="L39">        notificationJpaRepository.save(notification);</span>
<span class="fc" id="L40">        NotificationResponse response = NotificationResponse.of(notification);</span>
<span class="fc" id="L41">        simpMessagingTemplate.convertAndSend(&quot;/topic/notification/&quot; + notification.getReceiver().getId(), response);</span>
<span class="fc" id="L42">    }</span>

    @Transactional
    public void createGroupJoinApprovedNotification(UserProfile receiver, UserProfile sender, ReadingGroup group) {
<span class="fc" id="L46">        String message = String.format(&quot;%s 그룹의 가입 요청이 승인되었습니다.&quot;, group.getName());</span>
<span class="fc" id="L47">        Notification notification = new Notification(receiver, sender, null,group, null,null,null,NotificationType.GROUP_JOIN_APPROVED, message);</span>
<span class="fc" id="L48">        notificationJpaRepository.save(notification);</span>
<span class="pc bpc" id="L49" title="1 of 2 branches missed.">        if (receiver != null) {</span>
<span class="fc" id="L50">            NotificationResponse response = NotificationResponse.of(notification);</span>
<span class="fc" id="L51">            simpMessagingTemplate.convertAndSend(&quot;/topic/notification/&quot; + notification.getReceiver().getId(), response);</span>
        }
<span class="fc" id="L53">    }</span>

    @Transactional
    public void createGroupJoinRejectedNotification(UserProfile receiver, UserProfile sender, ReadingGroup group) {
<span class="fc" id="L57">        String message = String.format(&quot;%s 그룹의 가입 요청이 거절되었습니다.&quot;, group.getName());</span>
<span class="fc" id="L58">        Notification notification = new Notification(receiver, sender,null, group, null,null,null,NotificationType.GROUP_JOIN_REJECTED, message);</span>
<span class="fc" id="L59">        notificationJpaRepository.save(notification);</span>
<span class="pc bpc" id="L60" title="1 of 2 branches missed.">        if (receiver != null) {</span>
<span class="fc" id="L61">            NotificationResponse response = NotificationResponse.of(notification);</span>
<span class="fc" id="L62">            simpMessagingTemplate.convertAndSend(&quot;/topic/notification/&quot; + notification.getReceiver().getId(), response);</span>
        }
<span class="fc" id="L64">    }</span>

//    @Transactional
//    public void createPublisherJoinRequestNotification(UserProfile admin, PublisherProfile publisher) {
//        String message = String.format(&quot;%s님이 출판사 가입을 요청했습니다.&quot;, publisher.getPublisherName());
//        Notification notification = new Notification(null,admin, publisher, null, null,null,null,NotificationType.PUBLISHER_JOIN_REQUEST, message);
//        notificationJpaRepository.save(notification);
//    }

    @Transactional
    public void createPublisherApprovedNotification(PublisherProfile publisher, UserProfile admin) {
<span class="fc" id="L75">        String message = &quot;출판사 가입이 승인되었습니다.&quot;;</span>
<span class="fc" id="L76">        Notification notification = new Notification(admin,null,publisher, null,null, null,null,NotificationType.PUBLISHER_APPROVED, message);</span>
<span class="fc" id="L77">        notificationJpaRepository.save(notification);</span>
<span class="fc" id="L78">    }</span>

//    @Transactional
//    public void createPublisherRejectedNotification(PublisherProfile publisher, UserProfile admin) {
//        String message = &quot;출판사 가입이 거절되었습니다.&quot;;
//        Notification notification = new Notification(null, admin, publisher,null, null,null,null,NotificationType.PUBLISHER_REJECTED, message);
//        notificationJpaRepository.save(notification);
//    }

    @Transactional
    public void createDiscussionCommentNotification(UserProfile receiver, UserProfile sender, Discussion discussion) {
<span class="fc" id="L89">        String message = String.format(&quot;%s님이 %s 토론에 댓글을 달았습니다.&quot;, sender.getNickname(), discussion.getTitle());</span>
<span class="fc" id="L90">        Notification notification = new Notification(receiver, sender, null, null,null,discussion ,null,NotificationType.DISCUSSION_COMMENT, message);</span>
<span class="fc" id="L91">        notificationJpaRepository.save(notification);</span>
<span class="pc bpc" id="L92" title="1 of 2 branches missed.">        if (receiver != null) {</span>
<span class="fc" id="L93">            NotificationResponse response = NotificationResponse.of(notification);</span>
<span class="fc" id="L94">            simpMessagingTemplate.convertAndSend(&quot;/topic/notification/&quot; + notification.getReceiver().getId(), response);</span>
        }
<span class="fc" id="L96">    }</span>

    @Transactional
    public void createCommentReplyNotification(UserProfile receiver, UserProfile sender, DiscussionComment comment) {
<span class="fc" id="L100">        String message = String.format(&quot;%s님이 내 토론 댓글에 답글을 달았습니다.&quot;, sender.getNickname());</span>
<span class="fc" id="L101">        Notification notification = new Notification(receiver, sender, null, null,null,comment.getDiscussion(),comment,NotificationType.COMMENT_REPLY, message);</span>
<span class="fc" id="L102">        notificationJpaRepository.save(notification);</span>
<span class="pc bpc" id="L103" title="1 of 2 branches missed.">        if (receiver != null) {</span>
<span class="fc" id="L104">            NotificationResponse response = NotificationResponse.of(notification);</span>
<span class="fc" id="L105">            simpMessagingTemplate.convertAndSend(&quot;/topic/notification/&quot; + notification.getReceiver().getId(), response);</span>
        }
<span class="fc" id="L107">    }</span>

    @Transactional
    public void createHighlightCommentNotification(UserProfile receiver, UserProfile sender, Highlight highlight) {
<span class="fc" id="L111">        String message = String.format(&quot;%s님이 내 하이라이트에 댓글을 달았습니다.\n하이라이트 내용: %s&quot;, </span>
<span class="fc" id="L112">            sender.getNickname(), </span>
<span class="fc" id="L113">            highlight.getMemo());</span>
<span class="fc" id="L114">        Notification notification = new Notification(receiver, sender, null, null, highlight,null, null,NotificationType.HIGHLIGHT_COMMENT, message);</span>
<span class="fc" id="L115">        notificationJpaRepository.save(notification);</span>
<span class="pc bpc" id="L116" title="1 of 2 branches missed.">        if (receiver != null) {</span>
<span class="fc" id="L117">            NotificationResponse response = NotificationResponse.of(notification);</span>
<span class="fc" id="L118">            simpMessagingTemplate.convertAndSend(&quot;/topic/notification/&quot; + notification.getReceiver().getId(), response);</span>
        }
<span class="fc" id="L120">    }</span>

    @Transactional
    public void createHighlightCommentReplyNotification(UserProfile receiver, UserProfile sender, HighlightComment comment) {
<span class="fc" id="L124">        String message = String.format(&quot;%s님이 내 하이라이트 댓글에 답글을 달았습니다.\n하이라이트 내용: %s&quot;, </span>
<span class="fc" id="L125">            sender.getNickname(),</span>
<span class="fc" id="L126">            comment.getHighlight().getMemo());</span>
<span class="fc" id="L127">        Notification notification = new Notification(receiver, sender, null, null, comment.getHighlight(),null,null, NotificationType.HIGHLIGHT_COMMENT_REPLY, message);</span>
<span class="fc" id="L128">        notificationJpaRepository.save(notification);</span>
<span class="pc bpc" id="L129" title="1 of 2 branches missed.">        if (receiver != null) {</span>
<span class="fc" id="L130">            NotificationResponse response = NotificationResponse.of(notification);</span>
<span class="fc" id="L131">            simpMessagingTemplate.convertAndSend(&quot;/topic/notification/&quot; + notification.getReceiver().getId(), response);</span>
        }
<span class="fc" id="L133">    }</span>
    
    @Transactional
    public void createGroupBannedNotification(UserProfile receiver, ReadingGroup group) {
<span class="fc" id="L137">        String message = String.format(&quot;%s에서 추방되었습니다.&quot;, group.getName());</span>
<span class="fc" id="L138">        Notification notification = Notification.builder()</span>
<span class="fc" id="L139">                .receiver(receiver)</span>
<span class="fc" id="L140">                .group(group)</span>
<span class="fc" id="L141">                .type(NotificationType.GROUP_BANNED)</span>
<span class="fc" id="L142">                .message(message)</span>
<span class="fc" id="L143">                .build();</span>
<span class="fc" id="L144">        notificationJpaRepository.save(notification);</span>
<span class="pc bpc" id="L145" title="1 of 2 branches missed.">        if (receiver != null) {</span>
<span class="fc" id="L146">            NotificationResponse response = NotificationResponse.of(notification);</span>
<span class="fc" id="L147">            simpMessagingTemplate.convertAndSend(&quot;/topic/notification/&quot; + notification.getReceiver().getId(), response);</span>
        }
<span class="fc" id="L149">    }</span>

    public PageResponse&lt;NotificationResponse&gt; getNotifications(UserToken userToken, Pageable pageable) {
<span class="fc" id="L152">        UserProfile userProfile = userProfileRepository.findById(userToken.userId())</span>
<span class="fc" id="L153">                .orElseThrow(() -&gt; new NotFoundException(ErrorCode.USER_NOT_FOUND));</span>

<span class="fc" id="L155">        Page&lt;Notification&gt; notifications = notificationJpaRepository.findByReceiverOrderByCreatedAtDesc(userProfile, pageable);</span>
<span class="fc" id="L156">        Page&lt;NotificationResponse&gt; responsePage = notifications.map(NotificationResponse::of);</span>
        
<span class="fc" id="L158">        return PageResponse.of(responsePage);</span>
    }

    @Transactional
    public void markAsRead(UserToken userToken, Long notificationId) {
<span class="fc" id="L163">        UserProfile userProfile = userProfileRepository.findById(userToken.userId())</span>
<span class="fc" id="L164">                .orElseThrow(() -&gt; new NotFoundException(ErrorCode.USER_NOT_FOUND));</span>

<span class="fc" id="L166">        Notification notification = notificationJpaRepository.findById(notificationId)</span>
<span class="fc" id="L167">                .orElseThrow(() -&gt; new NotFoundException(ErrorCode.NOTIFICATION_NOT_FOUND));</span>

<span class="pc bpc" id="L169" title="1 of 2 branches missed.">        if (!notification.getReceiver().getId().equals(userProfile.getId())) {</span>
<span class="fc" id="L170">            throw new ForbiddenException(ErrorCode.NOTIFICATION_NOT_YOURS);</span>
        }

<span class="nc" id="L173">        notification.markAsRead();</span>
<span class="nc" id="L174">    }</span>
} 
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.10.202304240956</span></div></body></html>